# Configuration Apache pour AYKI Recruitment Platform
# Fichier: /etc/apache2/sites-available/ayki.votre-domaine.com.conf

<VirtualHost *:80>
    ServerName ayki.votre-domaine.com
    RewriteEngine On
    RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
</VirtualHost>

<VirtualHost *:443>
    ServerName ayki.votre-domaine.com

    SSLEngine on
    SSLCertificateFile    /etc/letsencrypt/live/votre-domaine.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/votre-domaine.com/privkey.pem
    Include               /etc/letsencrypt/options-ssl-apache.conf

    ProxyPreserveHost On
    ProxyRequests    Off

    # Headers de sécurité
    Header always set X-Frame-Options DENY
    Header always set X-Content-Type-Options nosniff
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

    # Configuration pour les fichiers statiques (Next.js export)
    DocumentRoot /var/www/html/ayki

    # Proxy pour l'API backend NestJS (port 3002 pour éviter les conflits)
    ProxyPass        /api http://127.0.0.1:3002/api nocanon
    ProxyPassReverse /api http://127.0.0.1:3002/api

    # Swagger UI pour l'administration
    ProxyPass        /api/docs http://127.0.0.1:3002/api/docs nocanon
    ProxyPassReverse /api/docs http://127.0.0.1:3002/api/docs

    # Health check
    ProxyPass        /health http://127.0.0.1:3002/health nocanon
    ProxyPassReverse /health http://127.0.0.1:3002/health

    # Configuration pour les WebSockets (si nécessaire pour les notifications)
    ProxyPass        /socket.io/ ws://127.0.0.1:3002/socket.io/
    ProxyPassReverse /socket.io/ ws://127.0.0.1:3002/socket.io/

    # Configuration pour les uploads de CV et documents (50MB)
    LimitRequestBody 52428800

    # Servir les fichiers statiques du frontend Next.js
    <Directory "/var/www/html/ayki">
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Configuration pour Next.js export
        RewriteEngine On
        
        # Ne pas rediriger les requêtes API
        RewriteCond %{REQUEST_URI} !^/api/
        RewriteCond %{REQUEST_URI} !^/health
        
        # Redirection pour les routes Next.js
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^(.*)$ /index.html [L]
    </Directory>

    # Configuration spécifique pour les assets
    <LocationMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 month"
        Header append Cache-Control "public, immutable"
    </LocationMatch>

    # Logs spécifiques à AYKI
    LogLevel info
    ErrorLog   ${APACHE_LOG_DIR}/ayki-error.log
    CustomLog  ${APACHE_LOG_DIR}/ayki-access.log combined
</VirtualHost>

# Configuration alternative si vous utilisez le frontend en mode serveur (port 3003)
# Décommentez cette section et commentez la section DocumentRoot ci-dessus

# <VirtualHost *:443>
#     ServerName ayki.votre-domaine.com
#     
#     SSLEngine on
#     SSLCertificateFile    /etc/letsencrypt/live/votre-domaine.com/fullchain.pem
#     SSLCertificateKeyFile /etc/letsencrypt/live/votre-domaine.com/privkey.pem
#     Include               /etc/letsencrypt/options-ssl-apache.conf
#     
#     ProxyPreserveHost On
#     ProxyRequests    Off
#     
#     # Headers de sécurité
#     Header always set X-Frame-Options DENY
#     Header always set X-Content-Type-Options nosniff
#     Header always set X-XSS-Protection "1; mode=block"
#     Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
#     
#     # Proxy pour l'API backend (port 3002)
#     ProxyPass        /api/ http://127.0.0.1:3002/api/
#     ProxyPassReverse /api/ http://127.0.0.1:3002/api/
#     
#     # Proxy pour le frontend Next.js (port 3003)
#     ProxyPass        / http://127.0.0.1:3003/
#     ProxyPassReverse / http://127.0.0.1:3003/
#     
#     # Configuration pour les uploads (50MB)
#     LimitRequestBody 52428800
#     
#     LogLevel info
#     ErrorLog   ${APACHE_LOG_DIR}/ayki-error.log
#     CustomLog  ${APACHE_LOG_DIR}/ayki-access.log combined
# </VirtualHost>